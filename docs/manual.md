# muver
This package was created with [Cookiecutter](https://github.com/audreyr/cookiecutter) and the [audreyr/cookiecutter-pypackage](https://github.com/audreyr/cookiecutter-pypackage) project template.

## Overview
muver is designed to call mutations in outgrowths from mutation accummulation experiments. Developed to address specific experimental challenges in yeast, muver is designed to leverage high sequencing depth and access to data from both ancestor and progeny.

## Requirements
muver was developed using Python 2.7.13. In addition to requirements specified in setup.py, muver requires installation of the following tools:
* [Bowtie2](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml)
* [GATK, version 3.7-0](https://software.broadinstitute.org/gatk/download/)
* [picard](https://broadinstitute.github.io/picard/)
* [samtools](http://www.htslib.org/download/)

## Installation
After download, nagivate to the muver directory. Proper function of muver requires the paths to depencies to be set.  To do this, manually set the paths in `paths.cfg` using a text editor.

After the correct paths have been set, install muver with the following command:

```
python setup.py install
```

## Functions
All of muvers functions may be accessed using its command line interface. General usage is as follows:

```
muver COMMAND [OPTIONS] [ARGS]...
```
Available commands:
* [run_pipeline](#run_pipeline)
* [call_mutations](#call_mutations)
* [calculate_bias_distribution](#calculate_bias_distribution)
* [calculate_depth_distribution](#calculate_depth_distribution)
* [calculate_depth_ratios](#calculate_depth_ratios)
* [calculate_read_depths](#calculate_read_depths)
* [correct_depths](#correct_depths)
* [create_repeat_file](#create_repeat_file)
* [fit_repeat_indel_rates](#fit_repeat_indel_rates)
* [index_reference](#index_reference)
* [plot_allelic_fraction](#plot_allelic_fraction)

### run_pipeline
```
muver run_pipeline [OPTIONS] REFERENCE_ASSEMBLY FASTQ_LIST CONTROL_SAMPLE_NAME EXPERIMENT_DIRECTORY
```

Runs the full muver pipeline, from FASTQs to called genotypes and mutations. For details about the mutation calling methodology, see the companion manuscript.

Input samples and parameters are specified in the `FASTQ_LIST` file. In this file, each row corresponds to an individual sample. The row contents are in turn are specified by header fields in the first row. For a complete example, see example_fastq_list.txt.

Prior to running, the reference assembly must be indexed and repeats called. To do this, run the muver functions [index_reference](#index_reference) and [create_repeat_file](#create_repeat_file).

#### Output format
Output files are placed into the `EXPERIMENT_DIRECTORY`. When `run_pipeline` is started, the following file structure is automatically generated in `EXPERIMENT_DIRECTORY`:
```
EXPERIMENT_DIRECTORY/
|   sample_info.txt
|-- bams/
|-- depth_distributions/
|-- filtered_sites/
|-- fits/
|-- gatk_output/
|-- log/
|-- output/
```
The sample_info.txt file contains parameters and paths to output files associated with the run. To tweak the parameters associated with analysis, the sample_info.txt file may be copied and modified; the modified file may then be used as an argument for [call_mutations](#call_mutations). Details for each additional output file can found in documentation for the associated function. The contents of each directory are described below:
* bams/

  Contains the final processed BAM alignment files. Alignment files are processed through the following steps:
  1.  Remove pairs mapping on different chromosomes.
  2.  Filter by mapping quality.
  3.  Add read groups by sample.
  4.  Deduplicate.
  5.  Realign indels (GATK).


* depth_distributions/

  Contains depth and strand bias distributions. In addition, contains bedGraph files describing read depths in processed BAM files. Depth and strand bias distributions are generated using [calculate_depth_distribution](#calculate_depth_distribution) and [calculate_bias_distribution](#calculate_bias_distribution), respectively. Read depths are calculated using [calculate_read_depths](#calculate_read_depths).
* filtered_sites/

  Contains regions filtered on the basis of abnormal read depth. These regions are called using [calculate_depth_distribution](#calculate_depth_distribution).
* fits/

  Contains details of the fitting of observed indel rates to logistic distributions. These files are generated using [fit_repeat_indel_rates](#fit_repeat_indel_rates).
* gatk_output/

  Contains files generated by GATK. A VCF file from GATK HaplotypeCaller is required to call mutations.
* logs/

  Contains log files from GATK processes.
* output/

  Contains final called mutations in both table and VCF formats. These files are generated using [call_mutations](#call_mutations).

#### Options
* `-p, --processes INTEGER`

  Number of processes/threads to allocate to muver and its dependencies (default 1)
* `--excluded_regions PATH`

  Path to a BED file specifying genomic regions to ignore during mutation calling.

#### Arguments
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format. Run the muver functions [index_reference](#index_reference) and [create_repeat_file](#create_repeat_file) prior to `run_pipeline`.
* `FASTQ_LIST`

  Path to a tab-delimited text file that describes files and parameters for each sample.
* `CONTROL_SAMPLE_NAME`

  Name of the control ancestor sample. Must be consistent with the name specified in the `FASTQ_LIST`.
* `EXPERIMENT_DIRECTORY`

  Path to the experiment directory, where output and intermediate files will be written.

#### FASTQ_LIST fields
* "Sample Name"

  Required. Name of the sample.
* "Mate 1 FASTQ"

  Required. Path to the mate 1 FASTQ file. If multiple FASTQ files are used, enter in a comma-separated list.
* "Mate 2 FASTQ"

  Path to the mate 2 FASTQ file. If multiple FASTQ files are used, enter in a comma-separted list consistent with mate 1.
* "Ploidy"

  Sets the base ploidy for the sample. Individual positions will be superceded by the CNV bedGraph. If not specified, a sample will be assumed to be diploid (ploidy = 2).
* "CNV bedGraph"

  Path to a bedGraph file with ploidy values for individual regions. If the value of a region is '0', no mutations will be called in that region.

### call_mutations
```
muver call_mutations [OPTIONS] REFERENCE_ASSEMBLY CONTROL_SAMPLE_NAME SAMPLE_LIST INPUT_VCF OUTPUT_HEADER
```
Calls mutations from a pre-computed GATK HaplotypeCaller VCF file.

Prior to running, the reference assembly must be indexed and repeats called. To do this, run the muver functions `index_reference` and `create_repeat_file`.

#### Output format
`call_mutations` generates two files describing the called mutations: a tab-delimited table (\*.txt) and a VCF file (\*.vcf).

The tab-delimited table contains the following fields for each mutation:

* "Chromosome"
* "Position"

  Refers to the left-most position of the reference allele.
* "Excluded Region"

  Indicates if the variant falls within a user-defined excluded region.
* "Alleles"

  Alleles detected at that position separated by commas. The first allele is the reference allele.
* "Intersects Repeat"

  Indicates if the variant falls within a called repeat (see [create_repeat_file](#create_repeat_file)).
* "Repeat Correction Applied"

  Indicates if a repeat correction was applied during genotype calling.


* "CONTROL_SAMPLE Depths"

  Per-allele, per-strand read depths for all alleles. For instance, the first two values correspond to the forward and reverse strand read counts of the first listed allele.
* "CONTROL_SAMPLE Zeros Flag"

  Indicates if at least two per-allele, per-strand depth values are greater than zero.
* "CONTROL_SAMPLE Depth Flag"

  Indicates if the sample has total read depth greater than or equal to a threshold of 20 reads.
* "CONTROL_SAMPLE Filter Flag"

  Indicates if the variant position intersects the filtered regions for the sample.
* "CONTROL_SAMPLE Ploidy"

  Ploidy for the sample at this position.
* "CONTROL_SAMPLE Genotype"

  Called genotype for the sample.
* "CONTROL_SAMPLE Subclonal Genotype"

  Called sub-clonal genotype for the sample.
* "CONTROL_SAMPLE Subclonal Frequency"

  Frequency of the called sub-clonal.
* "CONTROL_SAMPLE Genotyping Score"

  Score associated with the called genotype.

The following additional fields are included for each non-control sample:

* "SAMPLE Depths"

  Per-allele, per-strand read depths for all alleles. For instance, the first two values correspond to the forward and reverse strand read counts of the first listed allele.
* "SAMPLE Zeros Flag"

  Indicates if at least two per-allele, per-strand depth values are greater than zero.
* "SAMPLE Depth Flag"

  Indicates if the sample has total read depth greater than or equal to a threshold of 20 reads.
* "SAMPLE Filter Flag"

  Indicates if the variant position intersects the filtered regions for the sample.
* "SAMPLE Composite P Value"

  Composite P value for mutation calling. Made relative to the control sample.
* "SAMPLE Significant Flag"

  Indicates if the called mutations pass significance thresholds. Considers both composite and individual P values.
* "SAMPLE Ploidy"

  Ploidy for the sample at this position.
* "SAMPLE Genotype"

  Called genotype for the sample.
* "SAMPLE Subclonal Genotype"

  Called sub-clonal genotype for the sample.
* "SAMPLE Subclonal Frequency"

  Frequency of the called sub-clonal.
* "SAMPLE Genotyping Score"

  Score associated with the called genotype.
* "SAMPLE Mutations"

  Comma-delimited list of called mutations.

  Mutations are named according to [HGVS](http://varnomen.hgvs.org/) specifications. To address mutations not explicitly described in those specifications, the following conventions are used:

  * To describe copy-number variations, mutation names are formatted as follows: g.{POS}[gain/loss]{ALLELE}. For instance, g.1000gainAT describes a gain of the AT allele at genomic position 1000. The position reported is the left-most position of the associated reference allele.
  * If a non-reference allele is mutated, the position is given as the flanking nucleotides of the reference allele. For instance, if at genomic position 100 an A to C SNP was called where the reference allele was G, the following name would be used: g.99_101A>C.
  * Mutations are only identified as 'ins' or 'del' if the reference allele is modified. Otherwise, '>' notation is used. For instance, if a AT to A mutation was called where the reference allele was G at genomic position 100, the following name would be used: g.99_101AT>A

* "SAMPLE LoH Flag"

  Identifies a conversion event from one allele to another. Reported in a comma-delimited list with each entry corresponding to a called mutation.

The VCF file contains the following INFO fields:

* IntersectsRepeat

  Indicates if the variant falls within a called repeat (see [create_repeat_file](#create_repeat_file)).
* RepeatCorrectionApplied

  Indicates if a repeat correction was applied during genotype calling.

The VCF file contains the following FILTER fields:

* ExcRegion

  Indicates if the variant falls within a user-defined excluded region.

The VCF file contains the following FORMAT fields for each sample:

* SAC: Strand allele counts

  Per-allele, per-strand read depths for all alleles. For instance, the first two values correspond to the forward and reverse strand read counts of the first listed allele.
* ACF: Allele count flag

  Indicates if at least two per-allele, per-strand depth values are greater than zero.
* DF: Depth flag

  Indicates if the sample has total read depth greater than or equal to a threshold of 20 reads.
* PD: Ploidy

  Ploidy for the sample at this position.
* GT: Genotype

  Called genotype for the sample.
* SGT: Subclonal Genotype

  Called sub-clonal genotype for the sample.
* SF: Subclonal frequency

  Frequency of the called sub-clonal.
* SV: Subclonal valid flag

  Indicates if validity tests for the subclonal allele pass thresholds.
* SIG: Signficance flag

  Indicates if the called mutations pass significance thresholds. Considers both composite and individual P values.
* MT: Called mutations

  Comma-delimited list of called mutations.
* PAC: Called PAC flags

  Identifies a conversion event from one allele to another. Reported in a comma-delimited list with each entry corresponding to a called mutation.

#### Options
*  `--excluded_regions PATH`

   Path to a BED file specifying genomic regions to ignore during mutation calling.

#### Arguments
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format. Run the muver functions [index_reference](#index_reference) and [create_repeat_file](#create_repeat_file) prior to `call_mutations`.
* `CONTROL_SAMPLE_NAME`

  Name of the control ancestor sample. Must be consistent with the name specified in the `SAMPLE_LIST`.
* `SAMPLE_LIST`

  Path to a tab-delimited text file that describes files and parameters for each sample.
* `INPUT_VCF`

  Path to a VCF from GATK HaplotypeCaller to be used for mutation calling.
* `OUTPUT_HEADER`

  Path to be used as a prefix in naming output files.

#### SAMPLE_LIST headers
* "Sample Name"

  Required. Name of the sample.
*  "Merged BAM"

  Required. BAM file for aligned reads. For processing guidelines, see [run_pipeline](#run_pipeline) for details.
* "Strand Bias Std"

  Required. Strandard deviation of the natural log-transformed ratio of per-strand counts.
* "Repeat Indel Fits"

  Required. Path to a repeat indel fits file. Describes the frequencies of indels based on repeat unit length and repeat tract length. Generated by [fit_repeat_indel_rates](#fit_repeat_indel_rates).
* "Ploidy"

  Sets the base ploidy for the sample. Individual positions will be superceded by the CNV bedGraph. If not specified, a sample will be assumed to be diploid (ploidy = 2).
* "CNV bedGraph"

  Path to a bedGraph file with ploidy values for individual regions. If the value of a region is '0', no mutations will be called in that region.
* "Filtered Sites"

  Path to a filtered sites text file. Mutations are not called at positions described in this file. Generated by [calculate_depth_distribution](#calculate_depth_distribution).

### calculate_bias_distribution
```
muver calculate_bias_distribution [OPTIONS] BAM_FILE REFERENCE_ASSEMBLY OUTPUT_BIAS_DISTRIBUTION
```
Calculates the strand-bias distribution for a BAM file. For each position in the genome, finds the ratio of per-strand count and takes the natural log.  These values are then compiled in a histrogram and fit to a normal distribution. The histrogram and the parameters of the fit are reported in the output file.

#### Output format
The first two lines of the output file give the parameters of the fit. The remainder of the file gives a histogram of observed frequencies and the corresponding fit value.

#### Arguments
* `BAM_FILE`

  Path to the input BAM alignment file.
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format.
* `OUTPUT_BIAS_DISTRIBUTION`

  Path to the output text file describing the distribution of natural log-transformed per strand ratios.

### calculate_depth_distribution
```
muver calculate_depth_distribution [OPTIONS] BEDGRAPH_FILE REFERENCE_ASSEMBLY OUTPUT_DEPTH_DISTRIBUTION
```
Calculates the distribution of values for a bedGraph file. Generates a histogram of values and fits those values to a normal distribution. The histogram and the parameters of the fit are reported in the output file.

#### Output format
The first two lines of the output file give the parameters of the fit. The remainder of the file gives a histogram of observed frequencies and the corresponding fit value.

In the filtered regions file, each row corresponds to a filtered position.  Three values are given in each row: chromosome, position, and observed depth at that position.

#### Options
* `--output_filtered_regions TEXT`

  If specified, creates a list in text file format of positions to filter prior to mutation calling. Filters on the basis of abnormal depth relative to the distribution of values in the bedGraph file.

#### Arguments
* `BEDGRAPH_FILE`

  Path to a bedGraph file describing per-base depths.
* `REFERENCE_ASSEMBLY`

  Path to reference assembly in FASTA format.
* `OUTPUT_DEPTH_DISTRIBUTION`

  Path to the output text file describing the distribution of depth values.

### calculate_depth_ratios
```
muver calculate_depth_ratios [OPTIONS] BEDGRAPH_FILE REFERENCE_ASSEMBLY OUTPUT_FILE
```
For each position in the genome, finds the ratio of the depth at that position to the genome-wide mean. These ratios are then binned by the shorter distance to the end of a chromosome, and the median values of these bins are reported. Designed to aid in finding values for per-sample depth correction.

#### Output format
The output file considers values binned based on relative distances from chromosome ends, with each row corresponding to a given bin. The file has four fields: the bin start distance, the bin end distance, the center distance of the bin, and the median of binned values.

#### Options
* `--mean FLOAT`

  If specified, this value will be used as the mean. If not, the mean will automatically be calculated.

#### Arguments
* `BEDGRAPH_FILE`

  Path to the input bedGraph file describing per-base depths.
* `REFERENCE_ASSEMBLY`

  Path to reference assembly in FASTA format.
* `OUTPUT_FILE`

  Path to the output text file describing the mean ratios.

### calculate_read_depths
```
muver calculate_read_depths [OPTIONS] BAM_FILE REFERENCE_ASSEMBLY OUTPUT_BEDGRAPH
```
Considering an input BAM file, calculates per-position read depths and writes to a bedGraph file. Read depth values are found considering samtools mpileup values.

#### Output format
The output is in standard bedGraph format, with read depths reported in the fourth column.

#### Arguments
* `BAM_FILE`

  Path to the input BAM alignment file.
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format.
* `OUTPUT_BEDGRAPH`

  Path to the output bedGraph file describing per-base depths.

### correct_depths
```
muver correct_depths [OPTIONS] Y_INT SCALAR MEAN_LOG SD_LOG SLOPE REFERENCE_ASSEMBLY INPUT_BEDGRAPH OUTPUT_BEDGRAPH
```
Corrects depth values for samples with relatively higher depth at chromosome ends. Depth correction is performed using the sum of a log-normal cumulative distribution function and a linear function. The correction function is given below, where x is the distance from the chromosome end:

correction_factor(x) = SCALAR \* (1 - [1/2 + 1/2 erf((ln(x) - MEAN_LOG)) / (sqrt(2) \* SD_LOG)]) + Y_INT + SLOPE \* x

#### Output format
The output is in standard bedGraph format, with corrected read depths reported in the fourth column. Corrected depths are floored to the nearest integer.

#### Arguments
* `Y_INT`, `SCALAR`, `MEAN_LOG`, `SD_LOG`, `SLOPE`

  Parameters for the correction function.
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format.
* `INPUT_BEDGRAPH`

  Path to the input bedGraph file describing per-base depths.
* `OUTPUT_BEDGRAPH`

  Path to the output bedGraph file with corrected depth values.

### create_repeat_file
```
muver create_repeat_file [OPTIONS] FASTA_FILE OUTPUT_REPEAT_FILE
```
Considering an input FASTA file, finds all repeats, and writes to an output text file.

#### Output format
Each line in the output file corresponds to a single identified repeat.  Each line hsa six fields: the chromosome, the complete repeat sequence, the length of the repeat unit, the repeat unit sequence, the start position of the repeat sequence (exclusive), and the end position (inclusive).

#### Arguments
* `FASTA_FILE`

  Path to the input sequence file in FASTA format.
* `OUTPUT_REPEAT_FILE`

  Path to output text file describing discovered repeat sequences.

### fit_repeat_indel_rates
```
muver fit_repeat_indel_rates [OPTIONS] BAM_FILE REPEATS_FILE OUTPUT_FITS_FILE
```
Considering a BAM input file and a list of repeats, calculates the frequencies of indels in repeat regions and fits those values to a logistic function. Fits are found for each event class (insertion or deletion) and repeated sequence length, and fit parameters are written to an output text file. The repeats file is generated using [create_repeat_file](#create_repeat_file).

#### Output format
The output fits file describes parameters used to fit a logistic distribution to observed indel frequencies in repeat regions. Indels where grouped by the class of the intersected repeat and the length of associated repeat unit. Each line in the file gives fit parameters for a given indel group.

Optional output plots show the observed indel rates against fitted values. An individual plot is generated for each indel group. In plots, the observed frequencies are displayed as black dots, and the fitted values are displayed as a blue line.

#### Options
* `--output_plot_header TEXT`

  If specifies, plots the calculated fits against observed values. Plots are written to PNG files with the header used as a prefix.

#### Arguments
* `BAM_FILE`

  Path to the input BAM alignment file.
* `REPEATS_FILE`

  Path to the input repeats file.
* `OUTPUT_FITS_FILE`

  Path to the output text file containing fit parameters.

### index_reference
```
muver index_reference [OPTIONS] REFERENCE_ASSEMBLY
```
For the specified reference assembly, write index files in place. Indices are written using Bowtie2, picard, and samtools.

#### Arguments
* `REFERENCE_ASSEMBLY`

  Path to the input sequence file in FASTA format.

### plot_allelic_fraction
```
muver plot_allelic_fraction [OPTIONS] BAM_FILE REFERENCE_ASSEMBLY OUTPUT_FILE
```
Considering an input alignment file, report a histogram of allelic fractions. Designed to determine overall ploidy for a sample.

#### Arguments
* `BAM_FILE`

  Path to the input BAM alignment file.
* `REFERENCE_ASSEMBLY`

  Path to the reference assembly in FASTA format.
* `OUTPUT_FILE`

  Path to the output histogram text file.
